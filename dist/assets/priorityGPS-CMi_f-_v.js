const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CZv0Jra0.js","assets/index-BE6ttBIq.css"])))=>i.map(i=>d[i]);
var m=Object.defineProperty;var S=(c,t,i)=>t in c?m(c,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):c[t]=i;var u=(c,t,i)=>S(c,typeof t!="symbol"?t+"":t,i);import{l as a,a as o,G as P,s as v,b as f,_ as G}from"./index-CZv0Jra0.js";class g{constructor(){u(this,"activeCourses",new Map);u(this,"monitoringInterval",null);u(this,"transmissionInterval",null);u(this,"isTransmitting",!1);u(this,"gpsMethods",[{name:"Android Native",priority:1,isAvailable:()=>{var t;return!!((t=window==null?void 0:window.AndroidGPS)!=null&&t.startGPS)},start:async t=>{try{const i=window.AndroidGPS.startGPS(t.courseId,t.vehicleNumber,t.uit,t.token,t.status);return a(`✅ GPS nativ Android pornit: ${i}`),!0}catch(i){return o(`❌ GPS nativ Android eșuat: ${i}`),!1}},stop:async t=>{var i;try{(i=window==null?void 0:window.AndroidGPS)!=null&&i.stopGPS&&window.AndroidGPS.stopGPS(t)}catch(e){o(`❌ Oprire GPS nativ Android eșuată: ${e}`)}},transmit:async t=>{var i;try{return(i=window==null?void 0:window.AndroidGPS)!=null&&i.isActive?window.AndroidGPS.isActive(t.courseId):!0}catch{return!1}}},{name:"Capacitor Plugin",priority:2,isAvailable:()=>!!(window!=null&&window.CapacitorGPS),start:async t=>{try{const i=await window.CapacitorGPS.startGPS({courseId:t.courseId,vehicleNumber:t.vehicleNumber,uit:t.uit,authToken:t.token,status:t.status});return a(`✅ GPS Capacitor pornit: ${i}`),i.success||!1}catch(i){return o(`❌ GPS Capacitor eșuat: ${i}`),!1}},stop:async t=>{var i;try{(i=window==null?void 0:window.CapacitorGPS)!=null&&i.stopGPS&&await window.CapacitorGPS.stopGPS({courseId:t})}catch(e){o(`❌ Oprire GPS Capacitor eșuată: ${e}`)}},transmit:async t=>!0},{name:"JavaScript Backup",priority:3,isAvailable:()=>!0,start:async t=>(a(`🔥 GPS Backup JavaScript pornit pentru: ${t.courseId}`),!0),stop:async t=>{a(`🛑 GPS Backup JavaScript oprit pentru: ${t}`)},transmit:async t=>{try{const i=await P.getCurrentPosition({enableHighAccuracy:!0,timeout:1e4,maximumAge:1e3}),e=v.getSharedTimestamp(),s={uit:t.uit,vehicleNumber:t.vehicleNumber,latitude:i.coords.latitude,longitude:i.coords.longitude,timestamp:e,accuracy:i.coords.accuracy||0,speed:i.coords.speed||0,bearing:i.coords.heading||0,altitude:i.coords.altitude||0},r=await f(s,t.token);return r.success?(a(`✅ GPS JavaScript transmis cu succes pentru ${t.courseId}`),!0):(o(`❌ Transmisia GPS JavaScript eșuată: ${r.error}`),!1)}catch(i){return o(`❌ Eroare GPS JavaScript: ${i}`),!1}}}])}stopAllIntervals(){this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),this.transmissionInterval&&(clearInterval(this.transmissionInterval),this.transmissionInterval=null),this.isTransmitting=!1,a("🛑 ALL GPS intervals stopped for performance")}async startGPS(t,i,e,s,r){a(`🚀 PERFORMANCE GPS: Starting SINGLE optimal GPS method for ${t}`),this.stopAllIntervals();const n={courseId:t,vehicleNumber:i,uit:e,token:s,status:r,activeMethod:"none",lastSuccessfulTransmission:new Date().toISOString()},p=this.gpsMethods.find(l=>l.name==="Android Native");let d=!1;if(p&&p.isAvailable()&&(a("⚡ PERFORMANCE MODE: Using ONLY Android Native GPS (no JS intervals)"),await p.start(n)&&(n.activeMethod="android",d=!0,a("✅ Android Native GPS active - ZERO UI lag expected"))),!d){a("⚠️ Android GPS failed - using minimal Capacitor fallback");const l=this.gpsMethods.find(h=>h.name.includes("Capacitor"));l&&l.isAvailable()&&await l.start(n)&&(n.activeMethod="capacitor",d=!0,a("✅ Capacitor GPS active as fallback"))}if(!d)throw o(`❌ ALL GPS methods failed for ${t}`),new Error("No GPS method available");this.activeCourses.set(t,n),n.activeMethod==="android"?a("🏎️ ANDROID GPS ACTIVE: Skipping JavaScript intervals for maximum performance"):(this.startMonitoring(),this.startTransmissionInterval(),a("📊 Fallback monitoring active for non-Android GPS")),a(`✅ PERFORMANCE GPS started: ${t} using ${n.activeMethod} - lag-free operation`)}async stopGPS(t){const i=this.activeCourses.get(t);if(!i){a(`⚠️ Cursa ${t} nu a fost găsită pentru oprire`);return}a(`🛑 Oprire GPS pentru ${t} (metodă: ${i.activeMethod})`);const e=this.gpsMethods.find(s=>s.name.toLowerCase().includes(i.activeMethod));e&&await e.stop(t);try{const{guaranteedGPSService:s}=await G(async()=>{const{guaranteedGPSService:r}=await import("./index-CZv0Jra0.js").then(n=>n.c);return{guaranteedGPSService:r}},__vite__mapDeps([0,1]));await s.stopGPS(t),a(`✅ Backup GPS Garantat oprit pentru cursa ${t}`)}catch(s){a(`⚠️ Oprire backup GPS Garantat eșuată (poate nu rulează): ${s}`)}this.activeCourses.delete(t),this.activeCourses.size===0&&(this.stopMonitoring(),this.stopTransmissionInterval()),a(`✅ GPS oprit pentru ${t}. Curse active: ${this.activeCourses.size}`)}async updateStatus(t,i){const e=this.activeCourses.get(t);if(!e){a(`⚠️ Course ${t} not found for status update`);return}if(a(`🔄 Updating status for ${t}: ${e.status} → ${i}`),i===3||i===4){a(`🛑 GPS PRIORITAR: PAUZĂ/STOP (${i}) - Se elimină cursa ${t} din transmisia GPS activă`),await this.stopGPS(t);return}e.status=i,this.activeCourses.set(t,e),a(`✅ Status updated for ${t}: ${i}`)}startMonitoring(){this.monitoringInterval||(this.monitoringInterval=setInterval(async()=>{for(const[t,i]of this.activeCourses)await this.monitorCourse(i)},15e3),a("🔍 Monitorizare GPS pornită - verificare metode la fiecare 15 secunde"))}stopMonitoring(){this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null,a("⏹️ Monitorizare GPS oprită"))}startTransmissionInterval(){this.transmissionInterval||this.isTransmitting||(this.transmissionInterval=setInterval(async()=>{if(!this.isTransmitting){this.isTransmitting=!0;try{const t=Array.from(this.activeCourses.values()).filter(i=>i.status===2);if(t.length>0){a(`🔥 CICLU TRANSMISIE GPS PRIORITAR: ${t.length} curse active (status 2)`);for(const i of t)a(`📡 Transmitere GPS Prioritar pentru cursa: ${i.courseId} (UIT: ${i.uit})`),await this.transmitForCourse(i)}else a("⏸️ Nicio cursă activă cu status 2 - se sare transmisia GPS Prioritar")}finally{this.isTransmitting=!1}}},5e3),a("📡 Interval transmisie GPS pornit - la fiecare 5 secunde"))}stopTransmissionInterval(){this.transmissionInterval&&(clearInterval(this.transmissionInterval),this.transmissionInterval=null,this.isTransmitting=!1,a("📡 Interval transmisie GPS oprit"))}async monitorCourse(t){const i=this.gpsMethods.find(s=>s.name.toLowerCase().includes(t.activeMethod));if(!i)return;await i.transmit(t)?t.lastSuccessfulTransmission=new Date:(a(`❌ Metoda GPS ${i.name} eșuată pentru ${t.courseId}, se încearcă fallback...`),await this.switchToFallbackMethod(t))}async switchToFallbackMethod(t){a(`🔄 Switching to fallback method for ${t.courseId}`);const i=this.gpsMethods.find(s=>s.name.toLowerCase().includes(t.activeMethod));i&&await i.stop(t.courseId);const e=this.gpsMethods.filter(s=>s.isAvailable()&&!s.name.toLowerCase().includes(t.activeMethod)).sort((s,r)=>s.priority-r.priority);for(const s of e)if(await s.start(t)){t.activeMethod=s.name.toLowerCase().includes("android")?"android":s.name.toLowerCase().includes("capacitor")?"capacitor":"javascript",a(`✅ Switched to fallback method: ${s.name} for ${t.courseId}`),this.activeCourses.set(t.courseId,t);return}o(`❌ Toate metodele fallback au eșuat pentru ${t.courseId}`)}async transmitForCourse(t){const i=this.gpsMethods.find(e=>e.name.toLowerCase().includes(t.activeMethod));if(i)try{const e=v.getSharedTimestampISO(),s=`priority_gps_${t.courseId}_${e}`;if(window[s]){a(`⏭️ ANTI-DUPLICAT: GPS Prioritar sare ${t.courseId} - deja transmis de alt serviciu în acest ciclu`);return}window[s]=!0,await i.transmit(t)&&(t.lastSuccessfulTransmission=new Date().toISOString(),this.activeCourses.set(t.courseId,t),a(`✅ GPS Prioritar transmis cu succes pentru ${t.courseId}`))}catch(e){o(`❌ Transmisia GPS Prioritar eșuată pentru ${t.courseId}: ${e}`)}}getActiveCourses(){return Array.from(this.activeCourses.keys())}hasActiveCourses(){return this.activeCourses.size>0}async logoutClearAll(){a("🧹 GPS PRIORITAR: Șterge toate datele GPS și oprește toate transmisiile");const t=Array.from(this.activeCourses.keys());for(const i of t)await this.stopGPS(i);this.stopMonitoring(),this.stopTransmissionInterval(),this.activeCourses.clear(),a("✅ GPS PRIORITAR: Toate serviciile GPS oprite și curățate")}}const C=new g;export{C as priorityGPSService};
